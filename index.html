<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Jhopan VPN - Free VPN Configuration Generator</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        min-height: 100vh;
        padding: 20px;
        color: #e0e0e0;
        transition: all 0.3s ease;
      }

      body.light-mode {
        background: linear-gradient(135deg, #2a2a2a 0%, #3d3d3d 50%, #2a2a2a 100%);
        color: #333;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        position: relative;
        padding-top: 50px;
      }

      .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #2a2a2a;
        border: 1px solid #3a3a3a;
        border-radius: 50px;
        padding: 10px 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }

      body.light-mode .theme-toggle {
        background: #f0f0f0;
        border: 1px solid #ccc;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .theme-toggle:hover {
        background: #3a3a3a;
        transform: scale(1.05);
      }

      body.light-mode .theme-toggle:hover {
        background: #e0e0e0;
      }

      .theme-toggle span {
        font-size: 1.2em;
      }

      .theme-toggle-text {
        color: #e0e0e0;
        font-size: 0.9em;
        font-weight: 600;
      }

      body.light-mode .theme-toggle-text {
        color: #333;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
      }

      body.light-mode .header {
        color: white;
      }

      .header h1 {
        font-size: 3em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
        color: #b0b0b0;
      }

      .card {
        background: #2a2a2a;
        border: 1px solid #3a3a3a;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        transition: all 0.3s ease;
      }

      body.light-mode .card {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .card h2 {
        color: #ffffff;
        margin-bottom: 20px;
        font-size: 1.8em;
      }

      body.light-mode .card h2 {
        color: #1a1a1a;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #e0e0e0;
      }

      body.light-mode label {
        color: #333;
      }

      select,
      input {
        width: 100%;
        padding: 12px;
        border: 2px solid #3a3a3a;
        border-radius: 10px;
        font-size: 1em;
        transition: all 0.3s;
        background: #1a1a1a;
        color: #e0e0e0;
      }

      body.light-mode select,
      body.light-mode input {
        background: #f5f5f5;
        border: 2px solid #ddd;
        color: #333;
      }

      select:focus,
      input:focus {
        outline: none;
        border-color: #666;
      }

      body.light-mode select:focus,
      body.light-mode input:focus {
        border-color: #999;
      }

      .btn {
        background: linear-gradient(135deg, #333 0%, #555 100%);
        color: white;
        padding: 15px 40px;
        border: 1px solid #666;
        border-radius: 50px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
        transition: all 0.3s;
      }

      body.light-mode .btn {
        background: linear-gradient(135deg, #4a4a4a 0%, #666 100%);
        border: 1px solid #888;
      }

      .btn:hover {
        transform: translateY(-3px);
        background: linear-gradient(135deg, #444 0%, #666 100%);
      }

      body.light-mode .btn:hover {
        background: linear-gradient(135deg, #5a5a5a 0%, #777 100%);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-batch {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        border: 2px solid #666;
        margin-top: 20px;
      }

      body.light-mode .btn-batch {
        background: linear-gradient(135deg, #2d2d2d 0%, #3a3a3a 100%);
        border: 2px solid #777;
      }

      .btn-batch:hover {
        background: linear-gradient(135deg, #2d2d2d 0%, #3a3a3a 100%);
        border-color: #888;
      }

      body.light-mode .btn-batch:hover {
        background: linear-gradient(135deg, #3a3a3a 0%, #4a4a4a 100%);
        border-color: #999;
      }

      .result-box {
        background: #1a1a1a;
        border: 2px solid #3a3a3a;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        display: none;
      }

      body.light-mode .result-box {
        background: #f9f9f9;
        border: 2px solid #ddd;
      }

      .result-box.show {
        display: block;
      }

      .result-box textarea {
        width: 100%;
        min-height: 200px;
        padding: 15px;
        border: 1px solid #3a3a3a;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
        resize: vertical;
        background: #0d0d0d;
        color: #e0e0e0;
      }

      body.light-mode .result-box textarea {
        background: #ffffff;
        border: 1px solid #ccc;
        color: #333;
      }

      .copy-btn {
        background: #2d2d2d;
        border: 1px solid #4a4a4a;
        margin-top: 10px;
      }

      body.light-mode .copy-btn {
        background: #4a4a4a;
        border: 1px solid #666;
      }

      .copy-btn:hover {
        background: #3a3a3a;
      }

      body.light-mode .copy-btn:hover {
        background: #5a5a5a;
      }

      .features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .feature {
        text-align: center;
        padding: 20px;
        background: #1a1a1a;
        border: 1px solid #3a3a3a;
        border-radius: 10px;
      }

      body.light-mode .feature {
        background: #f9f9f9;
        border: 1px solid #ddd;
      }

      .feature-icon {
        font-size: 3em;
        margin-bottom: 10px;
      }

      .feature-title {
        font-weight: 600;
        color: #fff;
        margin-bottom: 5px;
      }

      body.light-mode .feature-title {
        color: #333;
      }

      .feature-desc {
        color: #999;
        font-size: 0.9em;
      }

      body.light-mode .feature-desc {
        color: #666;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        border: 4px solid #3a3a3a;
        border-top: 4px solid #666;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      body.light-mode .spinner {
        border: 4px solid #ddd;
        border-top: 4px solid #666;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .quick-links {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
      }

      .quick-link {
        background: #1a1a1a;
        border: 1px solid #3a3a3a;
        padding: 8px 16px;
        border-radius: 20px;
        text-decoration: none;
        color: #e0e0e0;
        font-size: 0.9em;
        transition: background 0.3s;
      }

      body.light-mode .quick-link {
        background: #f0f0f0;
        border: 1px solid #ccc;
        color: #333;
      }

      .quick-link:hover {
        background: #2d2d2d;
      }

      body.light-mode .quick-link:hover {
        background: #e0e0e0;
      }

      .server-item {
        background: #1a1a1a;
        border: 2px solid #3a3a3a;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      body.light-mode .server-item {
        background: #f9f9f9;
        border: 2px solid #ddd;
      }

      .server-item:hover {
        border-color: #666;
        transform: translateX(5px);
      }

      body.light-mode .server-item:hover {
        border-color: #999;
      }

      .server-item.selected {
        border-color: #888;
        background: #2d2d2d;
      }

      body.light-mode .server-item.selected {
        border-color: #999;
        background: #e9e9e9;
      }

      .server-info {
        flex: 1;
      }

      .server-name {
        font-weight: 600;
        color: #fff;
        margin-bottom: 5px;
      }

      body.light-mode .server-name {
        color: #333;
      }

      .server-details {
        font-size: 0.85em;
        color: #999;
      }

      body.light-mode .server-details {
        color: #666;
      }

      .server-ping {
        background: #4a4a4a;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9em;
        min-width: 80px;
        text-align: center;
      }

      body.light-mode .server-ping {
        background: #666;
        color: white;
      }

      .server-ping.fast {
        background: #2d2d2d;
        border: 1px solid #666;
      }

      .server-ping.medium {
        background: #3a3a3a;
        border: 1px solid #777;
      }

      /* Classes for inline styles replacement */
      .result-title {
        margin-bottom: 15px;
        color: #fff;
      }

      body.light-mode .result-title {
        color: #333;
      }

      .selected-config-box {
        background: #1a1a1a;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #3a3a3a;
      }

      body.light-mode .selected-config-box {
        background: #f9f9f9;
        border: 1px solid #ddd;
      }

      .selected-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .selected-server-name {
        color: #fff;
        font-weight: bold;
      }

      body.light-mode .selected-server-name {
        color: #333;
      }

      .selected-ping-badge {
        background: #2d2d2d;
        border: 1px solid #4a4a4a;
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.85em;
      }

      body.light-mode .selected-ping-badge {
        background: #666;
        border: 1px solid #888;
      }

      .selected-details {
        font-size: 0.9em;
        color: #999;
      }

      body.light-mode .selected-details {
        color: #666;
      }

      .loading-text {
        margin-top: 10px;
        color: #999;
      }

      body.light-mode .loading-text {
        color: #666;
      }

      .footer-text {
        color: #999;
      }

      body.light-mode .footer-text {
        color: #666;
      }

      .footer-link {
        color: #888;
        text-decoration: none;
        transition: color 0.3s;
      }

      body.light-mode .footer-link {
        color: #555;
      }

      .footer-link:hover {
        color: #aaa;
      }

      body.light-mode .footer-link:hover {
        color: #333;
      }

      .server-ping.slow {
        background: #4a4a4a;
        border: 1px solid #888;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon">ğŸŒ™</span>
        <span class="theme-toggle-text" id="themeText">Light Mode</span>
      </div>

      <div class="header">
        <h1>ğŸš€ Jhopan VPN</h1>
        <p>Free VPN Configuration Generator</p>
      </div>

      <div class="card">
        <h2>ğŸ“¥ Select VPN Server</h2>

        <div class="form-group">
          <label for="country">ğŸŒ Select Country:</label>
          <select id="country">
            <option value="ID">ğŸ‡®ğŸ‡© Indonesia</option>
            <option value="SG">ğŸ‡¸ğŸ‡¬ Singapore</option>
            <option value="US">ğŸ‡ºğŸ‡¸ United States</option>
            <option value="JP">ğŸ‡¯ğŸ‡µ Japan</option>
            <option value="KR">ğŸ‡°ğŸ‡· South Korea</option>
            <option value="HK">ğŸ‡­ğŸ‡° Hong Kong</option>
            <option value="DE">ğŸ‡©ğŸ‡ª Germany</option>
            <option value="FR">ğŸ‡«ğŸ‡· France</option>
            <option value="GB">ğŸ‡¬ğŸ‡§ United Kingdom</option>
            <option value="NL">ğŸ‡³ğŸ‡± Netherlands</option>
            <option value="CA">ğŸ‡¨ğŸ‡¦ Canada</option>
            <option value="AU">ğŸ‡¦ğŸ‡º Australia</option>
            <option value="BR">ğŸ‡§ğŸ‡· Brazil</option>
            <option value="IN">ğŸ‡®ğŸ‡³ India</option>
            <option value="MY">ğŸ‡²ğŸ‡¾ Malaysia</option>
            <option value="TH">ğŸ‡¹ğŸ‡­ Thailand</option>
            <option value="VN">ğŸ‡»ğŸ‡³ Vietnam</option>
            <option value="TR">ğŸ‡¹ğŸ‡· Turkey</option>
          </select>
        </div>

        <div class="form-group">
          <label for="protocol">ğŸ” Protocol:</label>
          <select id="protocol">
            <option value="vless">VLESS (Recommended)</option>
            <option value="trojan">Trojan</option>
            <option value="ss">Shadowsocks</option>
          </select>
        </div>

        <div class="form-group">
          <label for="security">ğŸ”’ Security:</label>
          <select id="security">
            <option value="443">TLS (Port 443) - Recommended</option>
            <option value="80">NTLS (Port 80) - No Encryption</option>
          </select>
        </div>

        <button class="btn" onclick="loadServers()">
          ğŸ” Show Available Servers
        </button>

        <button class="btn btn-batch" onclick="getBatchConfig()">
          ğŸ“¦ Get Batch Config (All Servers)
        </button>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p class="loading-text">Loading servers...</p>
        </div>

        <div class="result-box" id="serverList" style="display: none">
          <h3 class="result-title">ğŸ“¡ Available Servers</h3>
          <div id="servers"></div>
        </div>

        <div class="result-box" id="resultBox">
          <h3 class="result-title">âœ… Selected Config</h3>
          <div class="selected-config-box">
            <div class="selected-header">
              <strong id="selectedServer" class="selected-server-name">No server selected</strong>
              <span id="selectedPing" class="selected-ping-badge"></span>
            </div>
            <div class="selected-details" id="selectedDetails"></div>
          </div>

          <div class="form-group">
            <label for="format">ğŸ“‹ Convert to Format:</label>
            <select id="format" onchange="convertFormat()">
              <option value="raw">Raw Links (Universal)</option>
              <option value="v2ray">Base64 (V2Ray/V2RayNG)</option>
              <option value="clash">Clash YAML</option>
              <option value="sfa">Sing-Box JSON</option>
            </select>
          </div>

          <textarea id="configResult" readonly></textarea>
          <button class="btn copy-btn" onclick="copyConfig()">
            ğŸ“‹ Copy Config
          </button>
          <div class="quick-links">
            <a href="#" class="quick-link" onclick="openV2Ray()"
              >Open in V2RayN</a
            >
            <a href="#" class="quick-link" onclick="downloadConfig()"
              >ğŸ’¾ Download</a
            >
          </div>
        </div>
      </div>

      <div class="card">
        <h2>âœ¨ Features</h2>
        <div class="features">
          <div class="feature">
            <div class="feature-icon">ğŸŒ</div>
            <div class="feature-title">51 Countries</div>
            <div class="feature-desc">Global server coverage</div>
          </div>
          <div class="feature">
            <div class="feature-icon">âš¡</div>
            <div class="feature-title">High Speed</div>
            <div class="feature-desc">Optimized connections</div>
          </div>
          <div class="feature">
            <div class="feature-icon">ğŸ”’</div>
            <div class="feature-title">Secure</div>
            <div class="feature-desc">Encrypted traffic</div>
          </div>
          <div class="feature">
            <div class="feature-icon">ğŸ’¯</div>
            <div class="feature-title">100% Free</div>
            <div class="feature-desc">No subscription needed</div>
          </div>
        </div>
      </div>

      <div class="card" style="text-align: center">
        <p class="footer-text">Powered by Cloudflare Workers | Built with â¤ï¸ by Jhopan</p>
        <p style="margin-top: 10px; font-size: 0.9em">
          <a
            href="https://github.com/jhopan/Wokers-Jhopan"
            class="footer-link"
            >ğŸ“¦ GitHub Repository</a
          >
        </p>
      </div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const workerDomain = urlParams.get("host") || "jhopan.my.id";

      let serverData = [];
      let selectedServerIndex = -1;

      async function loadServers() {
        const country = document.getElementById("country").value;
        const protocol = document.getElementById("protocol").value;
        const port = document.getElementById("security").value;

        document.getElementById("loading").classList.add("show");
        document.getElementById("serverList").style.display = "none";
        document.getElementById("resultBox").classList.remove("show");

        try {
          const apiUrl = `https://${workerDomain}/api/v1/sub?cc=${country}&vpn=${protocol}&port=${port}&limit=50&format=raw`;
          const response = await fetch(apiUrl);
          const configText = await response.text();

          const configs = configText.split("\n").filter((line) => line.trim());
          serverData = configs.map((config, index) => {
            const decoded = decodeURIComponent(config);
            const hashMatch = decoded.match(/#(.+)$/);
            const serverName = hashMatch ? hashMatch[1] : `Server ${index + 1}`;
            const pathMatch = decoded.match(/path=([^&]+)/);
            const serverIP = pathMatch
              ? decodeURIComponent(pathMatch[1]).replace("/", "")
              : "";
            const ping = simulatePing(country);

            return {
              config: config,
              name: serverName,
              ip: serverIP,
              ping: ping,
              country: country,
            };
          });

          serverData.sort((a, b) => a.ping - b.ping);
          displayServers();

          document.getElementById("loading").classList.remove("show");
          document.getElementById("serverList").style.display = "block";
        } catch (error) {
          alert("Error loading servers: " + error.message);
          document.getElementById("loading").classList.remove("show");
        }
      }

      async function getBatchConfig() {
        const country = document.getElementById("country").value;
        const protocol = document.getElementById("protocol").value;
        const port = document.getElementById("security").value;

        document.getElementById("loading").classList.add("show");
        document.getElementById("serverList").style.display = "none";
        document.getElementById("resultBox").classList.remove("show");

        try {
          const apiUrl = `https://${workerDomain}/api/v1/sub?cc=${country}&vpn=${protocol}&port=${port}&limit=50&format=raw`;
          const response = await fetch(apiUrl);
          const configText = await response.text();

          const configs = configText.split("\n").filter((line) => line.trim());

          document.getElementById("loading").classList.remove("show");

          const securityType = port === "443" ? "TLS" : "NTLS";
          document.getElementById(
            "selectedServer"
          ).textContent = `Batch: All ${getCountryName(country)} Servers`;
          document.getElementById(
            "selectedPing"
          ).textContent = `${configs.length} servers`;
          document.getElementById("selectedDetails").innerHTML = `
            ğŸ“¦ Batch Mode: All servers from ${getCountryName(country)}<br>
            ğŸ” Protocol: ${protocol.toUpperCase()}<br>
            ğŸ”’ Security: ${securityType} (Port ${port})<br>
            ğŸ“Š Total Servers: ${configs.length}
          `;

          serverData = configs.map((config, index) => {
            const decoded = decodeURIComponent(config);
            const hashMatch = decoded.match(/#(.+)$/);
            const serverName = hashMatch ? hashMatch[1] : `Server ${index + 1}`;
            const pathMatch = decoded.match(/path=([^&]+)/);
            const serverIP = pathMatch
              ? decodeURIComponent(pathMatch[1]).replace("/", "")
              : "";

            return {
              config: config,
              name: serverName,
              ip: serverIP,
              country: country,
            };
          });

          selectedServerIndex = -1;

          document.getElementById("format").value = "raw";
          document.getElementById("configResult").value = configs.join("\n");
          document.getElementById("resultBox").classList.add("show");

          document
            .getElementById("resultBox")
            .scrollIntoView({ behavior: "smooth", block: "nearest" });
        } catch (error) {
          alert("Error loading batch config: " + error.message);
          document.getElementById("loading").classList.remove("show");
        }
      }

      function simulatePing(countryCode) {
        const pingRanges = {
          ID: [5, 25],
          SG: [15, 35],
          MY: [10, 30],
          TH: [20, 40],
          VN: [25, 45],
          JP: [35, 60],
          KR: [40, 65],
          HK: [30, 55],
          US: [150, 220],
          CA: [180, 250],
          GB: [200, 280],
          DE: [180, 260],
          FR: [190, 270],
          NL: [185, 265],
          AU: [120, 180],
          BR: [220, 320],
          IN: [45, 85],
          TR: [160, 240],
        };
        const range = pingRanges[countryCode] || [100, 200];
        return Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];
      }

      function displayServers() {
        const serversDiv = document.getElementById("servers");
        serversDiv.innerHTML = "";

        serverData.forEach((server, index) => {
          const pingClass =
            server.ping < 50 ? "fast" : server.ping < 100 ? "medium" : "slow";

          const serverDiv = document.createElement("div");
          serverDiv.className = "server-item";
          serverDiv.onclick = () => selectServer(index);

          serverDiv.innerHTML = `
            <div class="server-info">
                <div class="server-name">${server.name}</div>
                <div class="server-details">ğŸ“ ${server.ip}</div>
            </div>
            <div class="server-ping ${pingClass}">${server.ping}ms</div>
          `;

          serversDiv.appendChild(serverDiv);
        });
      }

      function selectServer(index) {
        selectedServerIndex = index;
        const server = serverData[index];

        document.querySelectorAll(".server-item").forEach((item, i) => {
          if (i === index) {
            item.classList.add("selected");
          } else {
            item.classList.remove("selected");
          }
        });

        const port = document.getElementById("security").value;
        const securityType = port === "443" ? "TLS" : "NTLS";

        document.getElementById("selectedServer").textContent = server.name;
        document.getElementById(
          "selectedPing"
        ).textContent = `${server.ping}ms`;
        document.getElementById("selectedDetails").innerHTML = `
          ğŸ“ Server: <code style="color: #fff">${server.ip}</code><br>
          ğŸŒ Country: ${getCountryName(server.country)}<br>
          ğŸ” Protocol: ${document
            .getElementById("protocol")
            .value.toUpperCase()}<br>
          ğŸ”’ Security: ${securityType} (Port ${port})
        `;

        document.getElementById("format").value = "raw";
        document.getElementById("configResult").value = server.config;
        document.getElementById("resultBox").classList.add("show");

        document
          .getElementById("resultBox")
          .scrollIntoView({ behavior: "smooth", block: "nearest" });
      }

      async function convertFormat() {
        const format = document.getElementById("format").value;
        const port = document.getElementById("security").value;
        const protocol = document.getElementById("protocol").value;

        if (selectedServerIndex === -1 && serverData.length > 0) {
          await convertBatchFormat(format);
          return;
        }

        if (selectedServerIndex === -1) return;

        const server = serverData[selectedServerIndex];
        const securityType = port === "443" ? "TLS" : "NTLS";

        document.getElementById("selectedDetails").innerHTML = `
          ğŸ“ Server: <code style="color: #fff">${server.ip}</code><br>
          ğŸŒ Country: ${getCountryName(server.country)}<br>
          ğŸ” Protocol: ${protocol.toUpperCase()}<br>
          ğŸ”’ Security: ${securityType} (Port ${port})<br>
          ğŸ“‹ Format: ${format.toUpperCase()}
        `;

        if (format === "raw") {
          document.getElementById("configResult").value = server.config;
          return;
        }

        try {
          const manualConverted = manualConvert(server.config, format);
          document.getElementById("configResult").value = manualConverted;
        } catch (error) {
          document.getElementById(
            "configResult"
          ).value = `Conversion failed: ${error.message}\n\nRaw config:\n${server.config}`;
        }
      }

      async function convertBatchFormat(format) {
        if (format === "raw") {
          const rawConfigs = serverData.map((s) => s.config).join("\n");
          document.getElementById("configResult").value = rawConfigs;
          return;
        }

        if (format === "v2ray") {
          const rawConfigs = serverData.map((s) => s.config).join("\n");
          document.getElementById("configResult").value = btoa(rawConfigs);
          return;
        }

        if (format === "clash") {
          const clashProxies = serverData
            .map((server, index) => {
              return manualConvertSingleClash(server.config, index === 0);
            })
            .join("\n");

          document.getElementById("configResult").value = clashProxies;
          return;
        }

        if (format === "sfa") {
          const singboxConfigs = serverData
            .map((server) => {
              try {
                const config = manualConvert(server.config, "sfa");
                return JSON.parse(config);
              } catch (e) {
                return null;
              }
            })
            .filter((c) => c !== null);

          const combinedConfig = {
            outbounds: singboxConfigs.flatMap((c) => c.outbounds || []),
          };

          document.getElementById("configResult").value = JSON.stringify(
            combinedConfig,
            null,
            2
          );
          return;
        }
      }

      function manualConvertSingleClash(rawConfig, isFirst) {
        const url = new URL(rawConfig);
        const protocol = url.protocol.replace(":", "");
        const uuid = url.username;
        const server = url.hostname;
        const port = url.port;
        const hash = decodeURIComponent(url.hash.replace("#", ""));

        const params = new URLSearchParams(url.search);
        const type = params.get("type") || "ws";
        const path = params.get("path") || "/";
        const host = params.get("host") || server;
        const security = params.get("security") || "none";
        const sni = params.get("sni") || server;
        const tls = security === "tls";

        let result = "";
        if (isFirst) {
          result = "proxies:\n";
        }

        if (protocol === "vless") {
          result += `  - name: ${hash}
    server: ${server}
    type: vless
    port: ${port}
    uuid: ${uuid}
    tls: ${tls}
    skip-cert-verify: true
    servername: ${sni}
    network: ${type}
    ws-opts:
      path: ${path}
      headers:
        Host: ${host}
    udp: true`;
        } else if (protocol === "trojan") {
          result += `  - name: ${hash}
    server: ${server}
    type: trojan
    port: ${port}
    password: ${uuid}
    skip-cert-verify: true
    sni: ${sni}
    network: ${type}
    ws-opts:
      path: ${path}
      headers:
        Host: ${host}
    udp: true`;
        } else if (protocol === "ss") {
          result += `  - name: ${hash}
    server: ${server}
    type: ss
    port: ${port}
    cipher: none
    password: ${uuid}
    plugin: v2ray-plugin
    plugin-opts:
      mode: websocket
      tls: ${tls}
      skip-cert-verify: true
      host: ${host}
      path: ${path}`;
        }

        return result;
      }

      function manualConvert(rawConfig, format) {
        const url = new URL(rawConfig);
        const protocol = url.protocol.replace(":", "");
        const uuid = url.username;
        const server = url.hostname;
        const port = url.port;
        const hash = decodeURIComponent(url.hash.replace("#", ""));

        const params = new URLSearchParams(url.search);
        const type = params.get("type") || "ws";
        const path = params.get("path") || "/";
        const host = params.get("host") || server;
        const security = params.get("security") || "none";
        const sni = params.get("sni") || server;

        switch (format) {
          case "clash":
            return generateClashYAML(
              protocol,
              hash,
              server,
              port,
              uuid,
              type,
              path,
              host,
              security,
              sni
            );
          case "v2ray":
            return btoa(rawConfig);
          case "sfa":
            return generateSingBox(
              protocol,
              hash,
              server,
              port,
              uuid,
              type,
              path,
              host,
              security,
              sni
            );
          default:
            return rawConfig;
        }
      }

      function generateClashYAML(
        protocol,
        name,
        server,
        port,
        uuid,
        netType,
        path,
        host,
        security,
        sni
      ) {
        const tls = security === "tls";

        if (protocol === "vless") {
          return `proxies:
  - name: ${name}
    server: ${server}
    type: vless
    port: ${port}
    uuid: ${uuid}
    tls: ${tls}
    skip-cert-verify: true
    servername: ${sni}
    network: ${netType}
    ws-opts:
      path: ${path}
      headers:
        Host: ${host}
    udp: true`;
        } else if (protocol === "trojan") {
          return `proxies:
  - name: ${name}
    server: ${server}
    type: trojan
    port: ${port}
    password: ${uuid}
    skip-cert-verify: true
    sni: ${sni}
    network: ${netType}
    ws-opts:
      path: ${path}
      headers:
        Host: ${host}
    udp: true`;
        } else if (protocol === "ss") {
          return `proxies:
  - name: ${name}
    server: ${server}
    type: ss
    port: ${port}
    cipher: none
    password: ${uuid}
    plugin: v2ray-plugin
    plugin-opts:
      mode: websocket
      tls: ${tls}
      skip-cert-verify: true
      host: ${host}
      path: ${path}`;
        }

        return "Unsupported protocol for Clash";
      }

      function generateSingBox(
        protocol,
        name,
        server,
        port,
        uuid,
        netType,
        path,
        host,
        security,
        sni
      ) {
        const tls = security === "tls";

        const config = {
          outbounds: [
            {
              type: protocol === "ss" ? "shadowsocks" : protocol,
              tag: name,
              server: server,
              server_port: parseInt(port),
            },
          ],
        };

        if (protocol === "vless") {
          config.outbounds[0].uuid = uuid;
          config.outbounds[0].tls = tls
            ? {
                enabled: true,
                server_name: sni,
                insecure: true,
              }
            : undefined;
          config.outbounds[0].transport = {
            type: netType,
            path: path,
            headers: { Host: host },
          };
        } else if (protocol === "trojan") {
          config.outbounds[0].password = uuid;
          config.outbounds[0].tls = {
            enabled: true,
            server_name: sni,
            insecure: true,
          };
          config.outbounds[0].transport = {
            type: netType,
            path: path,
            headers: { Host: host },
          };
        }

        return JSON.stringify(config, null, 2);
      }

      function getCountryName(code) {
        const countries = {
          ID: "ğŸ‡®ğŸ‡© Indonesia",
          SG: "ğŸ‡¸ğŸ‡¬ Singapore",
          US: "ğŸ‡ºğŸ‡¸ United States",
          JP: "ğŸ‡¯ğŸ‡µ Japan",
          KR: "ğŸ‡°ğŸ‡· South Korea",
          HK: "ğŸ‡­ğŸ‡° Hong Kong",
          DE: "ğŸ‡©ğŸ‡ª Germany",
          FR: "ğŸ‡«ğŸ‡· France",
          GB: "ğŸ‡¬ğŸ‡§ United Kingdom",
          NL: "ğŸ‡³ğŸ‡± Netherlands",
          CA: "ğŸ‡¨ğŸ‡¦ Canada",
          AU: "ğŸ‡¦ğŸ‡º Australia",
          BR: "ğŸ‡§ğŸ‡· Brazil",
          IN: "ğŸ‡®ğŸ‡³ India",
          MY: "ğŸ‡²ğŸ‡¾ Malaysia",
          TH: "ğŸ‡¹ğŸ‡­ Thailand",
          VN: "ğŸ‡»ğŸ‡³ Vietnam",
          TR: "ğŸ‡¹ğŸ‡· Turkey",
        };
        return countries[code] || code;
      }

      function copyConfig() {
        const textarea = document.getElementById("configResult");
        textarea.select();
        document.execCommand("copy");

        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = "âœ… Copied!";
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      }

      function openV2Ray() {
        const config = document.getElementById("configResult").value;
        const format = document.getElementById("format").value;

        if (format === "raw") {
          const firstLine = config.split("\n")[0];
          window.location.href = firstLine;
        } else {
          alert(
            "Direct open only works with Raw format. Please use Copy or Download instead."
          );
        }
        return false;
      }

      function downloadConfig() {
        const config = document.getElementById("configResult").value;
        const protocol = document.getElementById("protocol").value;
        const format = document.getElementById("format").value;
        const country = document.getElementById("country").value;

        let extension = "txt";
        if (format === "clash") extension = "yaml";
        else if (format === "sfa") extension = "json";
        else if (format === "v2ray") extension = "txt";

        const isBatch = selectedServerIndex === -1 && serverData.length > 0;
        const prefix = isBatch ? "batch" : "single";
        const filename = `jhopan-${prefix}-${country}-${protocol}-${format}-${Date.now()}.${extension}`;

        const blob = new Blob([config], { type: "text/plain" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
        return false;
      }

      window.onload = () => {
        // Load saved theme preference
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') {
          document.body.classList.add('light-mode');
          document.getElementById('themeIcon').textContent = 'â˜€ï¸';
          document.getElementById('themeText').textContent = 'Dark Mode';
        }
        
        loadServers();
      };

      function toggleTheme() {
        const body = document.body;
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        
        body.classList.toggle('light-mode');
        
        if (body.classList.contains('light-mode')) {
          themeIcon.textContent = 'â˜€ï¸';
          themeText.textContent = 'Dark Mode';
          localStorage.setItem('theme', 'light');
        } else {
          themeIcon.textContent = 'ğŸŒ™';
          themeText.textContent = 'Light Mode';
          localStorage.setItem('theme', 'dark');
        }
      }
    </script>
  </body>
</html>
</html>
